services:
  calibre-web-automated:
    image: ghcr.io/crocodilestick/calibre-web-automated:dev
    container_name: calibre-web-automated
    restart: always

    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
      - ADMIN_USERNAME=alexhouse
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme123}
      - HARDCOVER_TOKEN=${HARDCOVER_TOKEN}

    volumes:
      - cwa_config:/config
      - /library/ingest:/cwa-book-ingest
      - /library:/calibre-library
      - /library/plugins:/config/.config/calibre/plugins

    ports:
      - "8083:8083"

    deploy:
      resources:
        limits:
          memory: 1500M
        reservations:
          memory: 400M

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  syncthing:
    image: syncthing/syncthing:latest
    container_name: syncthing
    restart: always
    network_mode: host

    environment:
      - PUID=1000
      - PGID=1000
      - STGUIADDRESS=0.0.0.0:8384

    volumes:
      - syncthing_config:/var/syncthing
      - /library:/library

    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

volumes:
  cwa_config:
    driver: local
  syncthing_config:
    driver: local
